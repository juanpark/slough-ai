name: Deploy to AWS ECS

on:
  push:
    branches: [main]
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì§€ì›

env:
  AWS_REGION: ap-northeast-2
  STACK_NAME: slough-ai
  ECR_REPOSITORY: slough-ai

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    if: github.repository == 'juanpark/slough-ai'

    steps:
      # ---------------------------------------------------------------
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ---------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 2. AWS ìžê²© ì¦ëª… ì„¤ì •
      # ---------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------------
      # 3. ECR ë¡œê·¸ì¸
      # ---------------------------------------------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ---------------------------------------------------------------
      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push (ë ˆì´ì–´ ìºì‹œ ì‚¬ìš©)
      # ---------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set image URI output
        id: image
        run: |
          echo "uri=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------
      # 5. CloudFormation ìŠ¤íƒ ì—…ë°ì´íŠ¸ (ì •í™•í•œ ì—ëŸ¬ í•¸ë“¤ë§)
      # ---------------------------------------------------------------
      - name: Update CloudFormation stack
        id: cfn-update
        run: |
          set +e
          OUTPUT=$(aws cloudformation update-stack \
            --stack-name $STACK_NAME \
            --template-body file://infra/cloudformation.yaml \
            --capabilities CAPABILITY_IAM \
            --parameters \
              ParameterKey=AppImageURI,ParameterValue=${{ steps.image.outputs.uri }} \
              ParameterKey=DBPassword,UsePreviousValue=true \
              ParameterKey=SecretArn,UsePreviousValue=true \
              ParameterKey=CertificateArn,UsePreviousValue=true \
            2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            if echo "$OUTPUT" | grep -q "No updates are to be performed"; then
              echo "â„¹ï¸ CloudFormation: ë³€ê²½ ì‚¬í•­ ì—†ìŒ (ìŠ¤í‚µ)"
              echo "cfn_changed=false" >> $GITHUB_OUTPUT
            else
              echo "âŒ CloudFormation ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:"
              echo "$OUTPUT"
              exit 1
            fi
          else
            echo "âœ… CloudFormation ì—…ë°ì´íŠ¸ ì‹œìž‘ë¨"
            echo "cfn_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Wait for CloudFormation update
        if: steps.cfn-update.outputs.cfn_changed == 'true'
        run: |
          echo "â³ CloudFormation ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘..."
          aws cloudformation wait stack-update-complete \
            --stack-name $STACK_NAME
          echo "âœ… CloudFormation ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      # ---------------------------------------------------------------
      # 6. ë°°í¬ ì „ í˜„ìž¬ Task Definition ì €ìž¥ (ë¡¤ë°±ìš©)
      # ---------------------------------------------------------------
      - name: Save current task definitions for rollback
        id: pre-deploy
        run: |
          CLUSTER="${STACK_NAME}-cluster"
          for svc in app worker beat; do
            CURRENT_TD=$(aws ecs describe-services \
              --cluster $CLUSTER \
              --services "${STACK_NAME}-${svc}-service" \
              --query "services[0].taskDefinition" \
              --output text)
            echo "${svc}_td=${CURRENT_TD}" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ ${svc} í˜„ìž¬ TD: ${CURRENT_TD}"
          done

      # ---------------------------------------------------------------
      # 7. ECS ì„œë¹„ìŠ¤ ê°•ì œ ìž¬ë°°í¬ (ìƒˆ ì´ë¯¸ì§€ ì ìš©)
      # ---------------------------------------------------------------
      - name: Deploy ECS services
        run: |
          CLUSTER="${STACK_NAME}-cluster"
          for service in "${STACK_NAME}-app-service" "${STACK_NAME}-worker-service" "${STACK_NAME}-beat-service"; do
            echo "ðŸ”„ ìž¬ë°°í¬: $service"
            aws ecs update-service \
              --cluster $CLUSTER \
              --service $service \
              --force-new-deployment \
              > /dev/null
          done
          echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ìž¬ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ"

      # ---------------------------------------------------------------
      # 8. ì „ì²´ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
      # ---------------------------------------------------------------
      - name: Wait for all ECS services stable
        id: wait-stable
        run: |
          CLUSTER="${STACK_NAME}-cluster"
          SERVICES=("${STACK_NAME}-app-service" "${STACK_NAME}-worker-service" "${STACK_NAME}-beat-service")

          for service in "${SERVICES[@]}"; do
            echo "â³ ${service} ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
            if aws ecs wait services-stable \
              --cluster $CLUSTER \
              --services "$service"; then
              echo "âœ… ${service} ì•ˆì •í™” ì™„ë£Œ"
            else
              echo "âŒ ${service} ì•ˆì •í™” ì‹¤íŒ¨!"
              echo "stable=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          echo "stable=true" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------
      # 9. ë¡¤ë°± (ì•ˆì •í™” ì‹¤íŒ¨ ì‹œ)
      # ---------------------------------------------------------------
      - name: Rollback on failure
        if: failure() && steps.pre-deploy.outputs.app_td != ''
        run: |
          echo "ðŸ”™ ë¡¤ë°± ì‹œìž‘ â€” ì´ì „ Task Definitionìœ¼ë¡œ ë³µì›"
          CLUSTER="${STACK_NAME}-cluster"

          aws ecs update-service \
            --cluster $CLUSTER \
            --service "${STACK_NAME}-app-service" \
            --task-definition "${{ steps.pre-deploy.outputs.app_td }}" \
            --force-new-deployment > /dev/null

          aws ecs update-service \
            --cluster $CLUSTER \
            --service "${STACK_NAME}-worker-service" \
            --task-definition "${{ steps.pre-deploy.outputs.worker_td }}" \
            --force-new-deployment > /dev/null

          aws ecs update-service \
            --cluster $CLUSTER \
            --service "${STACK_NAME}-beat-service" \
            --task-definition "${{ steps.pre-deploy.outputs.beat_td }}" \
            --force-new-deployment > /dev/null

          echo "â³ ë¡¤ë°± ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
          aws ecs wait services-stable \
            --cluster $CLUSTER \
            --services "${STACK_NAME}-app-service"
          echo "âœ… ë¡¤ë°± ì™„ë£Œ"

      # ---------------------------------------------------------------
      # 10. ë°°í¬ ê²°ê³¼ ìš”ì•½
      # ---------------------------------------------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **ì´ë¯¸ì§€** | \`${{ steps.image.outputs.uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ìŠ¤íƒ** | \`$STACK_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ë¦¬ì „** | \`$AWS_REGION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ì»¤ë°‹** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

          ALB_DNS=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`ALBDNSName`].OutputValue' \
            --output text)
          echo "| **ALB** | \`$ALB_DNS\` |" >> $GITHUB_STEP_SUMMARY
